{% extends "layouts/boilerplate.html" %}

{% block content %}
<div class="container my-5 text-center">

  <!-- Profile Picture Upload (Clickable Image) -->
  <form method="post" enctype="multipart/form-data" class="mb-3" id="profileForm">
    {% csrf_token %}
    
    <label for="profileImageInput" style="cursor: pointer; display: inline-block; position: relative;">
      {% if user.profile_image %}
        <img id="profilePreview" src="{{ user.profile_image.url }}" alt="Profile"
             class="rounded-circle mb-3 shadow"
             style="width:150px; height:150px; object-fit:cover;">
      {% else %}
        <img id="profilePreview" src="https://via.placeholder.com/150x150?text=U" alt="User"
             class="rounded-circle mb-3 shadow"
             style="width:150px; height:150px; object-fit:cover;">
      {% endif %}

      <!-- Small camera icon overlay -->
      <span style="position:absolute; bottom:15px; right:15px; background:#fff; border-radius:50%; padding:8px; box-shadow:0 0 6px rgba(0,0,0,0.3);">
        <i class="fa fa-camera"></i>
      </span>
    </label>

    <!-- Hidden file input -->
    <input type="file" id="profileImageInput" name="profile_image" accept="image/*" 
           style="display: none;">
  </form>

  <!-- User Info -->
  <h2 class="fw-bold">{{ user.username }}</h2>
  <p class="text-muted">{{ user.email }}</p>

  <!-- Discount Banner -->
  {% if has_discount %}
    <div class="alert alert-success mt-3">
      ðŸŽ‰ Congratulations! You get <b>30% OFF</b> on your first booking!
    </div>
  {% endif %}

  <!-- Logout Button -->
  <div class="mt-3">
    <a href="{% url 'users:logout' %}" class="btn btn-danger px-4">
      <i class="fa-solid fa-right-from-bracket"></i> Log out
    </a>
  </div>

  <!-- Bookings Section -->
  <div class="mt-5 text-start">
    <h3>Your Bookings</h3>
    {% if bookings %}
      <ul class="list-group">
        {% for booking in bookings %}
          <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start">
            <div>
              <strong>{{ booking.listing.title }}</strong><br>
              <small>
                Check-in: {{ booking.check_in }} |
                Check-out: {{ booking.check_out }}<br>
                Nights: {{ booking.nights }}<br>
                Booked on: {{ booking.booked_at|date:"M d, Y H:i" }}
              </small>
            </div>
  
            <div class="mt-2 mt-md-0 text-md-end">
              <span class="badge bg-primary fs-6">
                ðŸ’° Total: â‚¹{{ booking.total_bill|floatformat:2 }}
              </span>
  
              {% if booking.is_paid %}
                <span class="badge bg-success ms-2">âœ… Paid</span>
              {% else %}
                <!-- Razorpay Pay Now Button -->
                <button 
                  class="btn btn-warning btn-sm mt-2 pay-now-btn" 
                  data-booking="{{ booking.id }}">
                  <i class="fa-solid fa-credit-card"></i> Pay Now
                </button>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">You havenâ€™t made any bookings yet.</p>
    {% endif %}
  </div>
</div>

<!-- Inline CSS to fix badge alignment -->
<style>
  .badge {
    font-size: 1rem;
    padding: 0.5em 0.9em;
    border-radius: 8px;
    vertical-align: middle;
  }
  .badge + .badge,
  .badge + .btn {
    margin-left: 8px;
  }
</style>

<!-- JS for live preview + Razorpay payment -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  // Profile picture live preview
  const fileInput = document.getElementById("profileImageInput");
  const previewImg = document.getElementById("profilePreview");
  const form = document.getElementById("profileForm");

  fileInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;  // show preview
      }
      reader.readAsDataURL(file);

      // auto-submit after preview (optional)
      setTimeout(() => form.submit(), 500);
    }
  });

  // Razorpay Pay Now integration
  document.querySelectorAll(".pay-now-btn").forEach(button => {
    button.addEventListener("click", async () => {
      const bookingId = button.dataset.booking;

      // disable + show loading
      button.disabled = true;
      button.innerHTML = "Redirecting...";

      try {
        const response = await fetch(`/payments/create-payment-order/${bookingId}/`, {
          method: "GET",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}"
          }
        });

        const data = await response.json();

        if (data.error) {
          alert(data.error);
          button.disabled = false;
          button.innerHTML = '<i class="fa-solid fa-credit-card"></i> Pay Now';
          return;
        }

        const options = {
          key: "{{ RAZORPAY_KEY_ID }}",  // Razorpay test/live key
          amount: data.amount,           // in paise
          currency: data.currency,
          name: data.name,
          order_id: data.order_id,
          handler: function(response){
            alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
            window.location.href = `/payments/success/${bookingId}/`;
          },
          theme: { color: "#3399cc" }
        };

        const rzp = new Razorpay(options);
        rzp.open();

      } catch (error) {
        console.error("Payment error:", error);
        alert("Error connecting to payment server.");
        button.disabled = false;
        button.innerHTML = '<i class="fa-solid fa-credit-card"></i> Pay Now';
      }
    });
  });
</script>
{% endblock %}
